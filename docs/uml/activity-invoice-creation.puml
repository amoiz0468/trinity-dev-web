@startuml Invoice Creation - Activity Diagram

!define RECT rectangle
skinparam activityBackgroundColor LightSkyBlue
skinparam activityBorderColor DarkBlue
skinparam activityStartColor Green
skinparam activityEndColor Red
skinparam activityDiamondBackgroundColor Yellow

title Invoice Creation Workflow

|Frontend|
start
:User selects customer;
:User adds products to cart;
note right
  - Select product
  - Set quantity
  - Verify stock availability
end note

:User enters payment details;
:Click "Create Invoice";

:Submit invoice data via POST /api/invoices/;
note right
  JSON payload includes:
  - customer_id
  - items array
  - payment_method
  - notes (optional)
end note

|Backend|
:Receive invoice request;
:Validate request data;

if (Data valid?) then (no)
  :Return 400 Bad Request;
  note right
    Missing or invalid fields
  end note
  |Frontend|
  :Display error message;
  stop
else (yes)
endif

:Check customer exists;
if (Customer found?) then (no)
  :Return 404 Not Found;
  |Frontend|
  :Display error message;
  stop
else (yes)
endif

:Validate each product;
fork
  :Check product exists;
fork again
  :Verify quantity > 0;
fork again
  :Check stock availability;
end fork

if (All products valid?) then (no)
  :Return 400 Bad Request;
  note right
    Invalid product or
    insufficient stock
  end note
  |Frontend|
  :Display error message;
  stop
else (yes)
endif

:Begin database transaction;

:Create Invoice object;
note right
  - Generate invoice_number
  - Set status = 'pending'
  - Set customer reference
  - Set payment_method
end note

:Create InvoiceItem objects;
note right
  For each item:
  - Link to invoice
  - Link to product
  - Store quantity
  - Store unit_price
  - Calculate total_price
  - Snapshot product info
end note

:Calculate invoice totals;
note right
  - subtotal = sum(items.total_price)
  - tax_amount = subtotal * tax_rate / 100
  - total_amount = subtotal + tax_amount
end note

:Update product stock;
note right
  Decrease quantity_in_stock
  for each product
end note

:Commit transaction;

if (Save successful?) then (no)
  :Rollback transaction;
  :Return 500 Server Error;
  |Frontend|
  :Display error message;
  stop
else (yes)
endif

:Return invoice with items (201 Created);

|Frontend|
:Display success message;
:Show invoice details;
:Option to print/download;

stop

@enduml
