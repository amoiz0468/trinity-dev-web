@startuml Product Sync with Open Food Facts - Activity Diagram

skinparam activityBackgroundColor LightYellow
skinparam activityBorderColor DarkOrange
skinparam activityStartColor Green
skinparam activityEndColor Red

title Product Synchronization with Open Food Facts API

|Manager/Frontend|
start
:Scan product barcode;
note right
  User scans barcode
  or enters manually
end note

:Submit barcode to backend;
:POST /api/products/sync-barcode/;

|Backend|
:Receive barcode;

:Validate barcode format;
if (Valid format?) then (no)
  :Return 400 Bad Request;
  |Manager/Frontend|
  :Display "Invalid barcode";
  stop
else (yes)
endif

:Check if product exists in DB;
if (Product exists?) then (yes)
  :Get existing product;
  if (Recently synced?) then (yes)
    note right
      last_synced < 24 hours ago
    end note
    :Return existing product;
    |Manager/Frontend|
    :Display product details;
    stop
  else (no)
  endif
else (no)
endif

:Query Open Food Facts API;
note right
  GET https://world.openfoodfacts.org/
  api/v2/product/{barcode}.json
end note

|Open Food Facts API|
:Process request;

if (Product found?) then (no)
  :Return 404 Not Found;
  |Backend|
  :Return 404 to frontend;
  note right
    Product not in OFF database
  end note
  |Manager/Frontend|
  :Display "Product not found";
  :Option to add manually;
  stop
else (yes)
  :Return product data;
endif

|Backend|
:Parse API response;

:Extract product information;
note right
  - Product name
  - Brand
  - Image URL
  - Barcode
  - Nutritional values
  - Categories
end note

:Map category;
note right
  Find or create matching
  Category in database
end note

if (Product exists in DB?) then (yes)
  :Update existing product;
  note right
    - Update nutritional info
    - Update image
    - Update OFF metadata
    - Set last_synced = now()
  end note
else (no)
  :Create new product;
  note right
    - Set default price = 0
    - Set quantity = 0
    - Set all OFF data
    - Set last_synced = now()
  end note
endif

:Save to database;

if (Save successful?) then (no)
  :Return 500 Server Error;
  |Manager/Frontend|
  :Display error message;
  stop
else (yes)
endif

:Return product data (200/201);
note right
  Include all product fields
  + sync status
end note

|Manager/Frontend|
:Display product details;
:Show sync success;

if (New product?) then (yes)
  :Prompt for price & quantity;
  note right
    OFF API doesn't provide
    retail price or stock
  end note
  :Update product;
else (no)
endif

:Product ready for sale;

stop

@enduml
